<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Figure 2: Fluctuation of Dominating Voices</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; max-width: 1200px; margin: auto; }
    canvas { max-width: 100%; height: 600px; }
    h2, h3 { text-align: center; }
    .year-checkboxes { display: flex; flex-wrap: wrap; gap: 1em; justify-content: center; margin: 1em 0; }
    .year-checkboxes label { display: flex; align-items: center; gap: 0.3em; }
    table { width: 100%; border-collapse: collapse; margin-top: 2em; font-size: 0.9em; }
    th, td { padding: 6px 12px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #f0f0f0; }
    tr:hover { background-color: #fafafa; }
  </style>
</head>
<body>

<h2>Figure 2: Fluctuation of Dominating Voices (Affiliation-based)</h2>
<div class="year-checkboxes" id="yearCheckboxContainer"></div>
<canvas id="timelineChart"></canvas>

<h3>Underlying Data Table</h3>
<div style="overflow-x:auto">
  <table id="dataTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<script>
let yearCounts = {}, allYears = new Set(), allAffiliations = new Set();
let chart;

function renderChart(selectedYears, sortedAffiliations) {
  const sortedYears = [...selectedYears].sort();

  const datasets = sortedAffiliations.map((affiliation, idx) => {
    const values = sortedYears.map(year => yearCounts[year]?.[affiliation] || 0);
    const color = `hsl(${idx * 360 / sortedAffiliations.length}, 70%, 50%)`;
    return {
      label: affiliation,
      data: values,
      borderColor: color,
      backgroundColor: color,
      borderDash: [6, 4],
      tension: 0,
      pointRadius: 3,
      fill: false
    };
  });

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("timelineChart"), {
    type: "line",
    data: {
      labels: sortedYears,
      datasets: datasets
    },
    options: {
      responsive: true,
      interaction: {
        mode: "nearest",
        axis: "x",
        intersect: false
      },
      onClick: (e, elements, chart) => {
        if (e.native?.detail === 2) chart.resetZoom();
      },
      plugins: {
        legend: { position: "top" },
        title: {
          display: true,
          text: "Figure 2: Fluctuation of Dominating Voices (Affiliation-based)"
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.raw;
              return value === 0 ? null : `${context.dataset.label}: ${value}`;
            }
          }
        },
        zoom: {
          pan: { enabled: true, mode: "x" },
          zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: "x" }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: "Number of narrative instances"
          }
        },
        x: {
          title: {
            display: true,
            text: "Year"
          }
        }
      }
    }
  });

  // Update Table
  const thead = document.querySelector("#dataTable thead");
  const tbody = document.querySelector("#dataTable tbody");
  thead.innerHTML = "";
  const headerRow = document.createElement("tr");
  headerRow.innerHTML = `<th>Affiliation</th>` + sortedYears.map(y => `<th>${y}</th>`).join("");
  thead.appendChild(headerRow);
  tbody.innerHTML = "";
  sortedAffiliations.forEach(aff => {
    const row = document.createElement("tr");
    const cells = sortedYears.map(y => `<td>${yearCounts[y]?.[aff] || 0}</td>`).join("");
    row.innerHTML = `<td>${aff}</td>` + cells;
    tbody.appendChild(row);
  });
}

function renderCheckboxes(yearList, sortedAffiliations) {
  const container = document.getElementById("yearCheckboxContainer");
  container.innerHTML = "";
  yearList.forEach(year => {
    const label = document.createElement("label");
    const input = document.createElement("input");
    input.type = "checkbox";
    input.value = year;
    input.checked = true;
    input.addEventListener("change", () => {
      const selectedYears = [...container.querySelectorAll("input:checked")].map(cb => parseInt(cb.value));
      renderChart(selectedYears, sortedAffiliations);
    });
    label.appendChild(input);
    label.appendChild(document.createTextNode(year));
    container.appendChild(label);
  });
}

fetch("emh_data.json")
  .then(res => res.json())
  .then(data => {
    data.forEach(row => {
      const affiliation = row.affiliation?.trim() || "N/A";
      const date = new Date(row.start_time);
      const year = date.getFullYear();
      if (!isNaN(year)) {
        allYears.add(year);
        allAffiliations.add(affiliation);
        if (!yearCounts[year]) yearCounts[year] = {};
        yearCounts[year][affiliation] = (yearCounts[year][affiliation] || 0) + 1;
      }
    });

    const sortedYears = [...allYears].sort();
    const affiliationTotals = {};
    Object.values(yearCounts).forEach(affMap => {
      Object.entries(affMap).forEach(([aff, count]) => {
        affiliationTotals[aff] = (affiliationTotals[aff] || 0) + count;
      });
    });

    const sortedAffiliations = [...allAffiliations].sort((a, b) =>
      (affiliationTotals[b] || 0) - (affiliationTotals[a] || 0)
    );

    renderCheckboxes(sortedYears, sortedAffiliations);
    renderChart(sortedYears, sortedAffiliations);
  })
  .catch(err => {
    console.error("Data load error:", err);
    const p = document.createElement("p");
    p.textContent = "Error loading data.";
    document.body.appendChild(p);
  });
</script>

</body>
</html>
