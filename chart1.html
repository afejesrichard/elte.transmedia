<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Figure 1: Percentages of Narrative Instance Affiliation</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; max-width: 900px; margin: auto; }
    canvas { max-width: 100%; }
    h2 { text-align: center; }
  </style>
</head>
<body>

  <h2>Figure 1: Percentages of Narrative Instance Affiliation</h2>
  <canvas id="ownershipChart"></canvas>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch('emh_data.json')
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
          return res.json();
        })
        .then(data => {
          const total = data.length;
          const affiliationCounts = {};

          data.forEach(row => {
            const affiliation = row["affiliation"]?.trim();
            if (affiliation) {
              affiliationCounts[affiliation] = (affiliationCounts[affiliation] || 0) + 1;
            }
          });

          const rawData = Object.entries(affiliationCounts).map(([label, count]) => ({
            label,
            count,
            percent: (count / total) * 100
          }));

          // Sort entries by percentage (descending)
          rawData.sort((a, b) => b.percent - a.percent);

          // Split into major and minor based on threshold
          const major = [], minor = [];
          rawData.forEach(entry => (entry.percent > 0.5 ? major : minor).push(entry));

          const labels = major.map(e => e.label);
          const dataValues = major.map(e => e.percent.toFixed(2));
          const colors = labels.map((_, i) =>
            `hsl(${i * 360 / (labels.length + 1)}, 65%, 55%)`
          );

          const otherTotal = minor.reduce((sum, e) => sum + e.percent, 0);
          const otherDetails = minor
            .sort((a, b) => b.percent - a.percent)
            .map(e => `${e.label}: ${e.percent.toFixed(2)}%`)
            .join('\n');

          if (otherTotal > 0) {
            labels.push("Other");
            dataValues.push(otherTotal.toFixed(2));
            colors.push("gray");
          }

          new Chart(document.getElementById('ownershipChart'), {
            type: 'pie',
            data: {
              labels: labels,
              datasets: [{
                data: dataValues,
                backgroundColor: colors,
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: ctx => {
                      if (ctx.label === "Other") {
                        return [`Other: ${ctx.parsed}%`, ...otherDetails.split('\n')];
                      }
                      return `${ctx.label}: ${ctx.parsed}%`;
                    }
                  }
                },
                legend: {
                  position: 'right'
                },
                title: {
                  display: true,
                  text: 'Figure 1: Percentages of Narrative Instance Affiliation'
                }
              }
            }
          });
        })
        .catch(err => {
          console.error("Fetch or Chart error:", err);
          const errorMsg = document.createElement("p");
          errorMsg.textContent = "There was an error loading the chart. Check console for details.";
          document.body.appendChild(errorMsg);
        });
    });
  </script>

</body>
</html>
