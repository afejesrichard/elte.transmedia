<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>The Beast Map (Final View)</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #cy { height: 94vh; width: 100vw; display: block; }
    #controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      padding: 8px 12px;
      background: #f4f4f4;
      border-bottom: 1px solid #ccc;
    }
    .legend-item {
      margin-right: 12px;
      display: inline-flex;
      align-items: center;
      font-size: 14px;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      margin-right: 6px;
      border: 1px solid black;
    }
    .btn {
      padding: 6px 14px;
      background: #0074D9;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 20px;
    }
  </style>
  <!-- Cytoscape and Hull plugin -->
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape-hull@1.4.2/cytoscape-hull.min.js"></script>
</head>
<body>

<div id="controls">
  <button class="btn" onclick="cy.fit()">Recenter View</button>
  <div id="legend"></div>
</div>
<div id="cy"></div>

<script>
const typeColors = {
  "Email": "#FF00FF",
  "Event": "#FF0000",
  "Object": "#999999",
  "Photo": "#FF6666",
  "Post": "#FFFF00",
  "Puzzle": "#FF6600",
  "Sound": "#00FFCC",
  "Video": "#00FF00",
  "Webpage": "#3333FF",
  "Other": "#CCCCCC"
};

const groupFiles = [
  "group1.txt", "group2.txt", "group3.txt", 
  "group4.txt", "group5.txt", "group6.txt"
];

let cy;

fetch("The_Beast_transmedia_map.cyjs")
  .then(res => res.json())
  .then(async data => {
    const nodes = data.elements.nodes
      .filter(n => n.data.owner !== "FAN")
      .map(n => ({
        data: {
          id: n.data.id,
          label: n.data.Label || n.data.id,
          type: n.data.type || "Other",
          centrality: parseFloat(n.data.BetweennessCentrality || 0)
        },
        position: n.position
      }));

    const nodeIds = new Set(nodes.map(n => n.data.id));
    const edges = data.elements.edges.filter(e =>
      nodeIds.has(e.data.source) && nodeIds.has(e.data.target)
    );

    const centralities = nodes.map(n => n.data.centrality);
    const minC = Math.min(...centralities);
    const maxC = Math.max(...centralities);

    cy = cytoscape({
      container: document.getElementById('cy'),
      elements: { nodes, edges },
      layout: { name: 'preset' },
      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'text-valign': 'center',
            'text-halign': 'center',
            'color': '#000',
            'background-color': ele => typeColors[ele.data('type')] || typeColors["Other"],
            'border-color': '#000',
            'border-width': 3,
            'width': `mapData(centrality, ${minC}, ${maxC}, 50, 500)`,
            'height': `mapData(centrality, ${minC}, ${maxC}, 50, 500)`,
            'font-size': `mapData(centrality, ${minC}, ${maxC}, 30, 60)`
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 1,
            'line-color': '#ccc',
            'curve-style': 'straight'
          }
        }
      ]
    });

    // Legend + Filter
    const legend = document.getElementById("legend");
    Object.entries(typeColors).forEach(([type, color]) => {
      const item = document.createElement("label");
      item.className = "legend-item";
      item.innerHTML = `
        <div class="legend-color" style="background:${color}"></div>
        <input type="checkbox" data-type="${type}" checked> ${type}
      `;
      legend.appendChild(item);
    });

    legend.querySelectorAll('input').forEach(cb => {
      cb.addEventListener('change', () => {
        const type = cb.dataset.type;
        const show = cb.checked;
        cy.nodes().forEach(n => {
          if (n.data('type') === type) {
            n.style('display', show ? 'element' : 'none');
          }
        });
      });
    });

    // Group overlays (hulls)
    const groupNodes = await Promise.all(groupFiles.map(f =>
      fetch(f).then(r => r.text()).then(txt =>
        txt.split(/\s+/).map(s => s.trim()).filter(Boolean)
      )
    ));

    cy.hull({
      name: 'group-hulls',
      members: groupNodes.map((ids, i) => ({
        name: `Group ${i + 1}`,
        nodes: ids,
        style: {
          fillColor: 'rgba(255,255,0,0.15)',
          strokeColor: '#999',
          lineWidth: 2,
          label: `Group ${i + 1}`
        }
      })),
      includeLabel: true
    });

    window.cy = cy;
  });
</script>

</body>
</html>
