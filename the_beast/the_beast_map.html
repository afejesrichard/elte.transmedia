<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>The Beast Map (Combined View)</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #cy { height: 94vh; width: 100vw; }
    #controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f4f4f4;
      border-bottom: 1px solid #ccc;
      padding: 6px 12px;
    }
    .legend-item {
      margin-right: 10px;
      display: inline-flex;
      align-items: center;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      margin-right: 5px;
      border: 1px solid black;
    }
    .btn {
      padding: 6px 12px;
      background: #0074D9;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
  </style>
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/cytoscape-hull@1.4.2/cytoscape-hull.js"></script>
</head>
<body>

<div id="controls">
  <button class="btn" onclick="cy.fit()">Recenter View</button>
  <div id="legend"></div>
</div>
<div id="cy"></div>

<script>
const typeColors = {
  "Email": "#FF00FF",
  "Event": "#FF0000",
  "Object": "#999999",
  "Photo": "#FF6666",
  "Post": "#FFFF00",
  "Puzzle": "#FF6600",
  "Sound": "#00FFCC",
  "Video": "#00FF00",
  "Webpage": "#3333FF",
  "Other": "#CCCCCC"
};

// Group label mapping (same filenames as group1.txt, etc.)
const groupFiles = ['group1.txt', 'group2.txt', 'group3.txt', 'group4.txt', 'group5.txt', 'group6.txt'];

let cy;

fetch("The_Beast_transmedia_map.cyjs")
  .then(res => res.json())
  .then(async data => {
    // Preprocess nodes
    const filteredNodes = data.elements.nodes
      .filter(n => n.data.owner !== "FAN")
      .map(n => ({
        data: {
          id: n.data.id,
          label: n.data.Label || n.data.id,
          type: n.data.type || "Other",
          centrality: parseFloat(n.data.BetweennessCentrality || 0)
        },
        position: n.position
      }));

    const nodeIdSet = new Set(filteredNodes.map(n => n.data.id));
    const filteredEdges = data.elements.edges.filter(e =>
      nodeIdSet.has(e.data.source) && nodeIdSet.has(e.data.target)
    );

    const centralities = filteredNodes.map(n => n.data.centrality);
    const minC = Math.min(...centralities);
    const maxC = Math.max(...centralities);

    cy = cytoscape({
      container: document.getElementById('cy'),
      elements: {
        nodes: filteredNodes,
        edges: filteredEdges
      },
      layout: { name: 'preset' },
      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'text-valign': 'center',
            'text-halign': 'center',
            'color': '#000',
            'background-color': ele => typeColors[ele.data('type')] || typeColors["Other"],
            'border-color': '#000',
            'border-width': 3,
            'width': `mapData(centrality, ${minC}, ${maxC}, 50, 500)`,
            'height': `mapData(centrality, ${minC}, ${maxC}, 50, 500)`,
            'font-size': `mapData(centrality, ${minC}, ${maxC}, 30, 60)`
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 2,
            'line-color': '#ccc',
            'curve-style': 'straight'
          }
        }
      ]
    });

    // Legend
    const legend = document.getElementById("legend");
    Object.entries(typeColors).forEach(([type, color]) => {
      const item = document.createElement("label");
      item.className = "legend-item";
      item.innerHTML = `
        <div class="legend-color" style="background:${color}"></div>
        <input type="checkbox" data-type="${type}" checked> ${type}
      `;
      legend.appendChild(item);
    });

    legend.querySelectorAll('input').forEach(cb => {
      cb.addEventListener('change', () => {
        const type = cb.dataset.type;
        const visible = cb.checked;
        cy.nodes().forEach(n => {
          if (n.data('type') === type) {
            n.style('display', visible ? 'element' : 'none');
          }
        });
      });
    });

    // Wait for groups to be loaded and apply hulls
    const groupNodes = await Promise.all(groupFiles.map(f =>
      fetch(f).then(res => res.text()).then(txt =>
        txt.split(/\s+/).map(id => id.trim()).filter(Boolean)
      )
    ));

    const hulls = cy.hull({
      name: "group-hulls",
      members: groupNodes.map((ids, i) => ({
        name: `group${i + 1}`,
        nodes: ids,
        style: {
          fillColor: 'rgba(255,255,0,0.15)',
          strokeColor: '#aaa',
          lineWidth: 2,
          label: `Group ${i + 1}`
        }
      })),
      includeLabel: true
    });

    window.cy = cy;
  });
</script>

</body>
</html>
