<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>The Beast Map</title>
  <style>
    body { font-family: Arial; margin: 0; }
    #cy { width: 100%; height: 95vh; display: block; }
    #controls {
      padding: 10px;
      background: #f8f8f8;
      border-bottom: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
      margin-right: 12px;
    }
    .legend-color {
      width: 16px;
      height: 16px;
      margin-right: 6px;
      border: 1px solid black;
    }
    .popper-box {
      background: rgba(255, 255, 150, 0.2);
      border: 1px dashed #999;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 14px;
      pointer-events: none;
    }
  </style>
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
  <script src="https://unpkg.com/cytoscape-popper/cytoscape-popper.js"></script>
</head>
<body>
  <div id="controls">
    <button onclick="cy.fit()">Recenter View</button>
    <div id="legend"></div>
  </div>
  <div id="cy"></div>

  <script>
    const typeColors = {
      "Email": "#FF00FF",
      "Event": "#FF0000",
      "Object": "#999999",
      "Photo": "#FF6666",
      "Post": "#FFFF00",
      "Puzzle": "#FF6600",
      "Sound": "#00FFCC",
      "Video": "#00FF00",
      "Webpage": "#3333FF",
      "Other": "#CCCCCC"
    };

    const sizeScale = (val, min = 50, max = 500) => {
      const clamped = Math.min(1, Math.max(0, val / 1000));
      return min + clamped * (max - min);
    };

    const fontScale = (val, min = 30, max = 60) => {
      const clamped = Math.min(1, Math.max(0, val / 1000));
      return min + clamped * (max - min);
    };

    fetch("The_Beast_transmedia_map.cyjs")
      .then(res => res.json())
      .then(data => {
        const filteredNodes = data.elements.nodes
          .filter(n => n.data.owner !== "FAN")
          .map(n => ({
            data: {
              id: n.data.id,
              label: n.data.Label || n.data.id,
              type: n.data.type || "Other",
              centrality: parseFloat(n.data.BetweennessCentrality || 0)
            },
            position: n.position
          }));

        const nodeIdSet = new Set(filteredNodes.map(n => n.data.id));
        const filteredEdges = data.elements.edges.filter(e =>
          nodeIdSet.has(e.data.source) && nodeIdSet.has(e.data.target)
        );

        const cy = cytoscape({
          container: document.getElementById('cy'),
          elements: {
            nodes: filteredNodes,
            edges: filteredEdges
          },
          layout: { name: 'preset' },
          style: [
            {
              selector: 'node',
              style: {
                'label': 'data(label)',
                'background-color': ele => typeColors[ele.data('type')] || typeColors["Other"],
                'width': ele => sizeScale(ele.data('centrality')),
                'height': ele => sizeScale(ele.data('centrality')),
                'font-size': ele => fontScale(ele.data('centrality')),
                'color': '#000',
                'text-valign': 'center',
                'text-halign': 'center',
                'border-width': 3,
                'border-color': '#000'
              }
            },
            {
              selector: 'edge',
              style: {
                'width': 2,
                'line-color': '#ccc'
              }
            }
          ]
        });

        // Legend
        const legendDiv = document.getElementById('legend');
        Object.entries(typeColors).forEach(([type, color]) => {
          const label = document.createElement('label');
          label.className = 'legend-item';
          label.innerHTML = `
            <div class="legend-color" style="background:${color}"></div>
            <input type="checkbox" checked data-type="${type}"> ${type}
          `;
          legendDiv.appendChild(label);
        });

        legendDiv.querySelectorAll('input[type=checkbox]').forEach(cb => {
          cb.addEventListener('change', () => {
            const type = cb.dataset.type;
            const visible = cb.checked;
            cy.nodes().forEach(n => {
              if (n.data('type') === type) {
                n.style('display', visible ? 'element' : 'none');
              }
            });
          });
        });

        // Popper group overlays
        const groupFiles = ['group1.txt', 'group2.txt', 'group3.txt', 'group4.txt', 'group5.txt', 'group6.txt'];
        groupFiles.forEach((file, idx) => {
          fetch(file)
            .then(res => res.text())
            .then(text => {
              const ids = text.trim().split(/\s+/);
              ids.forEach(id => {
                const node = cy.getElementById(id);
                if (node && node.isNode()) {
                  const ref = node.popperRef();
                  const tooltip = document.createElement('div');
                  tooltip.className = 'popper-box';
                  tooltip.textContent = `Group ${idx + 1}`;
                  document.body.appendChild(tooltip);
                  Popper.createPopper(ref, tooltip, {
                    placement: 'top',
                    modifiers: [{ name: 'offset', options: { offset: [0, 8] } }]
                  });
                }
              });
            });
        });

        window.cy = cy;
      })
      .catch(err => {
        document.body.innerHTML = "<p style='color:red'>Error loading graph.</p>";
        console.error(err);
      });
  </script>
</body>
</html>
