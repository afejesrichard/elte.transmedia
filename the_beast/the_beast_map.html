<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>The Beast Map with Overlays</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #wrapper { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
    #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    #cy {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1;
    }
    text {
      font-family: Arial;
      font-size: 18px;
      fill: black;
      text-anchor: middle;
    }
  </style>
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
</head>
<body>
<div id="wrapper">
  <svg id="overlay"></svg>
  <div id="cy"></div>
</div>
<script>
// Load overlay data from JSON file
fetch('group_hulls.json')
  .then(resp => resp.json())
  .then(overlayData => {
    // Draw SVG polygons
    const svg = document.getElementById("overlay");
    overlayData.forEach(group => {
      if (group.points.length < 3) return;
      let d = `M ${group.points[0][0]} ${group.points[0][1]}`;
      for (let j = 1; j < group.points.length; j++) {
        d += ` L ${group.points[j][0]} ${group.points[j][1]}`;
      }
      d += " Z";
      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d", d);
      path.setAttribute("fill", "rgba(255,255,0,0.13)");
      path.setAttribute("stroke", "#999");
      path.setAttribute("stroke-width", "2");
      svg.appendChild(path);
      // Center label
      const centroid = group.points.reduce((acc, [x, y]) => [acc[0]+x, acc[1]+y], [0,0]).map(z => z/group.points.length);
      const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
      label.setAttribute("x", centroid[0]);
      label.setAttribute("y", centroid[1]);
      label.textContent = group.group;
      svg.appendChild(label);
    });
  });

// Cytoscape visualization
fetch("The_Beast_transmedia_map.cyjs")
  .then(res => res.json())
  .then(data => {
    const nodes = data.elements.nodes
      .filter(n => n.data.owner !== "FAN")
      .map(n => ({
        data: {
          id: n.data.id,
          label: n.data.Label || n.data.id,
          type: n.data.type || "Other",
          centrality: parseFloat(n.data.BetweennessCentrality || 0)
        },
        position: n.position
      }));
    const nodeIds = new Set(nodes.map(n => n.data.id));
    const edges = data.elements.edges.filter(e =>
      nodeIds.has(e.data.source) && nodeIds.has(e.data.target)
    );
    cytoscape({
      container: document.getElementById("cy"),
      elements: { nodes, edges },
      layout: { name: "preset" },
      style: [
        {
          selector: "node",
          style: {
            "label": "data(label)",
            "background-color": "#999",
            "border-color": "#000",
            "border-width": 2,
            "width": 20,
            "height": 20,
            "font-size": 10,
            "color": "#000",
            "text-valign": "center",
            "text-halign": "center"
          }
        },
        {
          selector: "edge",
          style: {
            "width": 1,
            "line-color": "#ccc",
            "curve-style": "straight"
          }
        }
      ]
    });
  });
</script>
</body>
</html>
