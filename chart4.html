<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Figure 4: Fluctuation of Channel Usage</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; max-width: 1200px; margin: auto; }
    canvas { max-width: 100%; height: 600px; }
    h2, h3 { text-align: center; }
    .year-checkboxes { display: flex; flex-wrap: wrap; gap: 1em; margin-bottom: 1em; justify-content: center; }
    .year-checkboxes label { display: flex; align-items: center; gap: 0.3em; }
    table { width: 100%; border-collapse: collapse; margin-top: 2em; font-size: 0.9em; }
    th, td { padding: 6px 12px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #f0f0f0; }
    tr:hover { background-color: #fafafa; }
  </style>
</head>
<body>

<h2>Figure 4: Fluctuation of Channel Usage (Separately Counted)</h2>

<div class="year-checkboxes" id="yearCheckboxContainer"></div>
<canvas id="channelChart"></canvas>

<h3>Underlying Data Table</h3>
<div style="overflow-x:auto">
  <table id="dataTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const channelMap = {
    EMAIL: "E-mail", FD: "Filedropper", GD: "Google Docs", INT: "Internet", IRC: "IRC",
    MC: "Minecraft", MF: "Mediafire", RL: "Real Life", SA: "Something Awful Forum", TMB: "Tumblr",
    TP: "Twitpic", TW: "Twitter", UF: "Unfiction", UST: "Ustream", YT: "YouTube"
  };

  let chart;
  const yearCheckboxContainer = document.getElementById("yearCheckboxContainer");
  let yearCounts = {}, counts = {}, labels = [], allYears = [];

  fetch("emh_data.json")
    .then(res => res.json())
    .then(data => {
      data.forEach(row => {
        const raw = row.platform;
        if (!raw || typeof raw !== "string") return;
        const code = raw.trim().toUpperCase();
        const label = channelMap[code] || "Other";

        const date = new Date(row.start_time);
        const year = date.getFullYear();
        if (isNaN(year)) return;

        yearCounts[year] = (yearCounts[year] || 0) + 1;
        if (!counts[year]) counts[year] = {};
        counts[year][label] = (counts[year][label] || 0) + 1;
      });

      allYears = Object.keys(yearCounts).map(Number).sort((a, b) => a - b);
      labels = [...new Set(Object.values(counts).flatMap(obj => Object.keys(obj)))];

      renderCheckboxes();
      renderChart(allYears);
    });

  function renderCheckboxes() {
    yearCheckboxContainer.innerHTML = '';
    allYears.forEach(year => {
      const label = document.createElement("label");
      const input = document.createElement("input");
      input.type = "checkbox";
      input.value = year;
      input.checked = true;
      input.addEventListener("change", updateFromCheckboxes);
      label.appendChild(input);
      label.appendChild(document.createTextNode(year));
      yearCheckboxContainer.appendChild(label);
    });
  }

  function updateFromCheckboxes() {
    const selectedYears = Array.from(
      yearCheckboxContainer.querySelectorAll("input[type=checkbox]:checked")
    ).map(cb => parseInt(cb.value));
    renderChart(selectedYears);
  }

  function renderChart(filteredYears) {
    const totalPerLabel = {};
    labels.forEach(label => {
      totalPerLabel[label] = filteredYears.reduce((sum, y) => sum + (counts[y]?.[label] || 0), 0);
    });

    const sortedLabels = [...labels].sort((a, b) => totalPerLabel[b] - totalPerLabel[a]);

    const datasets = sortedLabels.map((label, i) => {
      const color = `hsl(${i * 360 / sortedLabels.length}, 70%, 45%)`;
      return {
        label: label,
        data: filteredYears.map(y => counts[y]?.[label] || 0),
        borderColor: color,
        backgroundColor: color,
        borderDash: [4, 4],
        tension: 0,
        pointRadius: 3,
        fill: false
      };
    });

    if (chart) chart.destroy();
    const ctx = document.getElementById("channelChart");
    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: filteredYears,
        datasets: datasets
      },
      options: {
        responsive: true,
        interaction: {
          mode: "nearest",
          axis: "x",
          intersect: false
        },
        onClick: (e, elements, chart) => {
          if (e.native?.detail === 2) chart.resetZoom();
        },
        plugins: {
          legend: { position: "top" },
          title: {
            display: true,
            text: "Figure 4: Fluctuation of Channel Usage (Separately Counted)"
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const val = context.raw;
                return val === 0 ? null : `${context.dataset.label}: ${val}`;
              }
            }
          },
          zoom: {
            pan: { enabled: true, mode: "x" },
            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: "x" }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: "Number of sites per year"
            }
          },
          x: {
            title: {
              display: true,
              text: "Year"
            }
          }
        }
      }
    });

    updateDataTable(filteredYears, sortedLabels);
  }

  function updateDataTable(filteredYears, sortedLabels) {
    const thead = document.querySelector("#dataTable thead");
    const tbody = document.querySelector("#dataTable tbody");

    // Header
    thead.innerHTML = "";
    const headerRow = document.createElement("tr");
    headerRow.innerHTML = `<th>Platform</th>` + filteredYears.map(y => `<th>${y}</th>`).join("");
    thead.appendChild(headerRow);

    // Rows
    tbody.innerHTML = "";
    sortedLabels.forEach(label => {
      const row = document.createElement("tr");
      const cells = filteredYears.map(y => `<td>${counts[y]?.[label] || 0}</td>`).join("");
      row.innerHTML = `<td>${label}</td>` + cells;
      tbody.appendChild(row);
    });
  }
</script>

</body>
</html>
