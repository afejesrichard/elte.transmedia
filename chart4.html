<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Figure 4: Fluctuation of Channel Usage</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; max-width: 1200px; margin: auto; }
    canvas { max-width: 100%; height: 600px; }
    h2 { text-align: center; }
  </style>
</head>
<body>

<h2>Figure 4: Fluctuation of Channel Usage (Separately Counted)</h2>
<canvas id="channelChart"></canvas>

<script>
  const vocabMap = {
    EMAIL: "E-mail", FD: "Filedropper", GD: "Google Docs", INT: "Internet", IRC: "IRC",
    MC: "Minecraft", MF: "Mediafire", RL: "Real Life", SA: "Something Awful Forum", TMB: "Tumblr",
    TP: "Twitpic", TW: "Twitter", UF: "Unfiction", UST: "Ustream", YT: "YouTube"
  };

  fetch("emh_data.json")
    .then(res => res.json())
    .then(data => {
      const counts = {};
      const allYears = new Set();
      const allChannels = new Set();

      data.forEach(row => {
        const date = new Date(row.start_time);
        const year = date.getFullYear();
        if (isNaN(year)) return;
        allYears.add(year);

        const raw = row.vocabulary;
        if (typeof raw !== "string") return;

        raw.split(",").map(s => s.trim().toUpperCase()).forEach(code => {
          const label = vocabMap[code] || "Other";
          allChannels.add(label);
          if (!counts[year]) counts[year] = {};
          counts[year][label] = (counts[year][label] || 0) + 1;
        });
      });

      const years = [...allYears].sort();
      const channels = [...allChannels];

      const totalPerChannel = {};
      channels.forEach(ch => {
        totalPerChannel[ch] = years.reduce((sum, y) => sum + (counts[y]?.[ch] || 0), 0);
      });

      const sortedChannels = channels.sort((a, b) => totalPerChannel[b] - totalPerChannel[a]);

      const datasets = sortedChannels.map((ch, i) => {
        const color = `hsl(${i * 360 / sortedChannels.length}, 70%, 45%)`;
        return {
          label: ch,
          data: years.map(y => counts[y]?.[ch] || 0),
          borderColor: color,
          backgroundColor: color,
          borderDash: [4, 4],
          tension: 0,
          pointRadius: 3,
          fill: false
        };
      });

      const ctx = document.getElementById("channelChart");
      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: years,
          datasets: datasets
        },
        options: {
          responsive: true,
          interaction: {
            mode: "nearest",
            axis: "x",
            intersect: false
          },
          onClick: (e, elements, chart) => {
            if (e.native?.detail === 2) chart.resetZoom();
          },
          plugins: {
            legend: {
              position: "top"
            },
            title: {
              display: true,
              text: "Figure 4: Fluctuation of Channel Usage (Separately Counted)"
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const val = context.raw;
                  return val === 0 ? null : `${context.dataset.label}: ${val}`;
                }
              }
            },
            zoom: {
              pan: {
                enabled: true,
                mode: "x"
              },
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                mode: "x"
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Number of sites per year"
              }
            },
            x: {
              title: {
                display: true,
                text: "Year"
              }
            }
          }
        }
      });
    })
    .catch(err => {
      console.error("Error loading chart data:", err);
      const p = document.createElement("p");
      p.textContent = "Error loading data.";
      document.body.appendChild(p);
    });
</script>

</body>
</html>
